---
title: "Energy Portfolio Optim"
author: "Matthew Aaron Looney"
date: "10/08/2017"
output: pdf_document
---

```{r echo=FALSE, message=FALSE, results='asis', cache=F}

cat("\014")
rm(list=ls())
set.seed(12345)
options(scipen=999)

library(quadprog)
library(dygraphs)
library(readr)
library(ggthemes)
library(ggplot2)
library(reshape2)
library(stargazer)

energy_mix_percent_csv <- read_csv("~/Desktop/Energy/energy_mix_percent_csv.csv")
years <- 2008:2017

gas_plot<- as.numeric(energy_mix_percent_csv[2, 2:10])
gas_plot <- matrix(gas_plot, nrow=9)

coal_plot<- as.numeric(energy_mix_percent_csv[4, 2:10])
coal_plot <- matrix(coal_plot, nrow=9)

nuke_plot<- as.numeric(energy_mix_percent_csv[5, 2:10])
nuke_plot <- matrix(nuke_plot, nrow=9)

wind_plot<- as.numeric(energy_mix_percent_csv[6, 2:10])
wind_plot <- matrix(wind_plot, nrow=9)

hydro_plot<- as.numeric(energy_mix_percent_csv[8, 2:10])
hydro_plot <- matrix(hydro_plot, nrow=9)

#solar_plot<- as.numeric(energy_mix_percent_csv[7, 2:11])
#solar_plot <- matrix(solar_plot, nrow=10)

sourcePercent_plot <- data.frame(Natural_Gas=gas_plot, Coal=coal_plot, Nuclear=nuke_plot, Wind=wind_plot, Hyrdroelectric=hydro_plot, years=years[-10])

melted_sourcePercent_plot <- melt(sourcePercent_plot, id.vars="years")
colnames(melted_sourcePercent_plot) <- c("years", "source", "source_percent")

ggplot(data=melted_sourcePercent_plot, aes(years, source_percent, col=source))+
geom_point()+
stat_smooth(se=F)+ 
theme_bw()+
ggtitle("Historical Data")

stargazer(energy_mix_percent_csv[1:6,], energy_mix_percent_csv[7:13,], header=F, type="latex", summary = F, font.size = "small", notes= c(), notes.align= "l", flip = T, float = T, float.env = "table", title="Historical Energy Source Percent", median = F, colnames=F)







# Expxected cost of resources in 2022 [million USD/TWh]
# Source: http://en.wikipedia.org/wiki/Cost_of_electricity_by_source
c <- matrix(c(71, 90, 59, 88, 111, 156, 76))

#Standard deviation of resource cost [million USD/TWh]
sig <- c(11, 30, 9, 9.5, 30, 16, 10)

#Maximum expected cost [million USD/TWh]
cmax <- 80

#ERCOT Demand in 2016 [TWh]
d <- 351

Q <- diag(2* sig^2)
R <- c(rep(0, 7))

a1 <- matrix(rep(-1, 7), nrow=1) #sum of source mix >= demand
a2 <- t(c-cmax) # cost constraint
a3 <- diag(c(-1, -1, -1, -1, -1, -1, -1)) #Non-negativity
a4 <- matrix(c(0, 1, 0, 0, 0, 0, 0), nrow=1) #Hydro <=2 TWh 
a5 <- matrix(c(-1, 0, -1, -1, 0, 0, 0), nrow=1) # 60% <= base power 
a6 <- matrix(c(1, 0, 1, 1, 0, 0, 0), nrow=1) #base power <= 90%
a7 <- matrix(c(0, 0, 0, 0, 0, 1, 0), nrow=1) #PV Solar <= 7%
a8 <- matrix(c(0, 0, 0, 0, 0, 0, 1), nrow=1) #wind <= 25%
a9 <- matrix(c(0, 0, 0, 0, 1, 0, 0), nrow=1) #wind <= 0.05%

# constraints A=LHS, b=RHS
A <- rbind(a1, a2, a3, a4, a5, a6, a7, a8, a9)
b <- c(d, 0, 0, 0, 0, 0, 0, 0, 0, -d*0.005, d*.6, -d*0.9, -d*0.07, -d*0.25, -d*0.005)

qp <- solve.QP(Dmat=Q, dvec=R, Amat=t(A), bvec=b, factorized=F)

qp.soln <- data.frame(id=1:length(c), source= -qp$solution)
    
rownames(qp.soln) <- c("coal", "hydro", "natural_gas", "nuclear", "biomass", "solar", "wind")
    
plot(qp.soln[,2], type="h", ylab="Power provisioned from resource i [TWh]")





################################################################################
#Maximum expected cost [million USD/TWh]
cmax_range <- 61:150
qp.value <- data.frame(risk=rep(NA, length(cmax_range)))
i <- 1
for(i in 1:length(cmax_range)){
  
  a1_range <- matrix(rep(-1, 7), nrow=1)
  a2_range <- t(c- cmax_range[i])
  a3_range <- diag(c(-1, -1, -1, -1, -1, -1, -1))
  a4_range <- matrix(c(0, 1, 0, 0, 0, 0, 0), nrow=1)
  a5_range <- matrix(c(-1, 0, -1, -1, 0, 0, 0), nrow=1) # 60% <= base power 
  a6_range <- matrix(c(1, 0, 1, 1, 0, 0, 0), nrow=1) #base power <= 90%
  a7_range <- matrix(c(0, 0, 0, 0, 0, 1, 0), nrow=1) #PV Solar <= 7%
  a8_range <- matrix(c(0, 0, 0, 0, 0, 0, 1), nrow=1) #wind <= 25%
  a9_range <- matrix(c(0, 0, 0, 0, 1, 0, 0), nrow=1) #wind <= 0.05%
  
  A_range <- rbind(a1_range, a2_range, a3_range, a4_range, a5_range, a6_range, a7_range, a8_range, a9_range)
  
  qp_range <- solve.QP(Dmat=Q, dvec=R, Amat=t(A_range), bvec=b)
  qp.value[i,1] <- qp_range$value
  
  i <- i+1
}

plot(x=cmax_range, y=qp.value[,1]/1000000, type="l", xlab="Max Expected Energy Cost in 2020 [million USD/TWh]", ylab="Variance / Risk [Billion USD^2]")


```


